services:
  # ========================================
  # PostgreSQL - Base de données CI/CD
  # ========================================
  postgres:
    image: postgres:15-alpine
    container_name: cicd-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5433:5432"
    networks:
      - cicd-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # Redis - Queue pour les jobs pipeline
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: cicd-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - cicd-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # Backend Node.js - API + WebSocket
  # ========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cicd-backend
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: production
      PORT: 3002
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:30000}
      BACKEND_URL: http://localhost:3002
      # Database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: cicd_db
      POSTGRES_USER: cicd_user
      POSTGRES_PASSWORD: cicd_pass
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # Pipeline mode
      PIPELINE_MODE: ${PIPELINE_MODE:-real}
      # GitHub OAuth (à configurer)
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}
      # JWT Secret
      JWT_SECRET: ${JWT_SECRET:-cicd-platform-jwt-secret-2024}
      # GitHub Webhook
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET:-your_webhook_secret}
      # VM SSH (à configurer)
      VM_HOST: ${VM_HOST:-192.168.1.100}
      VM_USER: ${VM_USER:-deployer}
      SSH_KEY_PATH: /app/ssh/vm_deployer
      # SonarQube
      SONAR_URL: ${SONAR_URL:-http://sonarqube:9000}
      SONAR_TOKEN: ${SONAR_TOKEN:-}
      SONAR_EXTERNAL_URL: ${SONAR_EXTERNAL_URL:-http://localhost:30090}
      # App repo
      APP_REPO_URL: ${APP_REPO_URL:-https://github.com/Saad-Rafik-Etu-IMT/demo.git}
      # Git Polling
      GIT_POLLING_ENABLED: ${GIT_POLLING_ENABLED:-false}
      GIT_POLLING_INTERVAL: ${GIT_POLLING_INTERVAL:-300000}
      GIT_POLLING_BRANCH: ${GIT_POLLING_BRANCH:-master}
    volumes:
      - ./ssh:/app/ssh:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - cicd-network
    restart: unless-stopped

  # ========================================
  # Frontend React - Dashboard
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: http://localhost:3002
        VITE_WS_URL: ws://localhost:3002
    container_name: cicd-frontend
    ports:
      - "3000:80"
    environment:
      VITE_API_URL: http://localhost:3002
      VITE_WS_URL: ws://localhost:3002
    depends_on:
      - backend
    networks:
      - cicd-network
    restart: unless-stopped

  # ========================================
  # SonarQube - Analyse de qualité de code
  # ========================================
  sonarqube:
    image: sonarqube:lts-community
    container_name: cicd-sonarqube
    ports:
      - "9001:9000"
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://sonar-db:5432/sonarqube
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar
      # Optimisation mémoire pour environnement local
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    depends_on:
      sonar-db:
        condition: service_healthy
    networks:
      - cicd-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9000/api/system/status | grep -q UP || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s

  # ========================================
  # PostgreSQL pour SonarQube
  # ========================================
  sonar-db:
    image: postgres:15-alpine
    container_name: cicd-sonar-db
    environment:
      POSTGRES_DB: sonarqube
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar
    volumes:
      - sonar_db_data:/var/lib/postgresql/data
    networks:
      - cicd-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sonar -d sonarqube"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # OWASP ZAP - Tests de sécurité (Optionnel)
  # Décommentez pour activer les scans avancés
  # ========================================
  # zap:
  #   image: ghcr.io/zaproxy/zaproxy:stable
  #   container_name: cicd-zap
  #   command: zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true -config api.disablekey=true
  #   ports:
  #     - "8090:8080"
  #   networks:
  #     - cicd-network
  #   restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  sonarqube_data:
    driver: local
  sonarqube_extensions:
    driver: local
  sonarqube_logs:
    driver: local
  sonar_db_data:
    driver: local

networks:
  cicd-network:
    driver: bridge
