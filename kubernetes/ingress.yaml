# ========================================
# Ingress - Configuration pour accès externe
# ========================================
# Nécessite un Ingress Controller (nginx-ingress, traefik, etc.)
# Pour installer nginx-ingress:
# kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml
# ========================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cicd-platform-ingress
  namespace: cicd-platform
  labels:
    app.kubernetes.io/name: cicd-platform
    app.kubernetes.io/component: ingress
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    # Pour WebSocket
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/use-regex: "true"
    # Décommentez pour TLS avec cert-manager
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: nginx
  # Décommentez pour TLS
  # tls:
  #   - hosts:
  #       - cicd.example.com
  #       - api.cicd.example.com
  #       - sonar.cicd.example.com
  #     secretName: cicd-platform-tls
  rules:
    # Frontend Dashboard
    - host: cicd.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: cicd-frontend
                port:
                  number: 80
    # Backend API
    - host: api.cicd.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: cicd-backend
                port:
                  number: 3002
    # SonarQube
    - host: sonar.cicd.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: cicd-sonarqube
                port:
                  number: 9000
---
# Ingress alternatif avec un seul domaine et chemins
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cicd-platform-ingress-paths
  namespace: cicd-platform
  labels:
    app.kubernetes.io/name: cicd-platform
    app.kubernetes.io/component: ingress
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  ingressClassName: nginx
  rules:
    - host: cicd.local
      http:
        paths:
          - path: /api(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: cicd-backend
                port:
                  number: 3002
          - path: /sonar(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: cicd-sonarqube
                port:
                  number: 9000
          - path: /
            pathType: Prefix
            backend:
              service:
                name: cicd-frontend
                port:
                  number: 80
