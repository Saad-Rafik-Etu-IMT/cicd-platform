const express = require('express')
const router = express.Router()
const pentestService = require('../services/pentestService')
const pool = require('../config/database')
const { authenticateToken, requireRole } = require('../middleware/auth')

// All routes require authentication
router.use(authenticateToken)

/**
 * GET /api/pentest/status
 * Check if OWASP ZAP is available
 */
router.get('/status', async (req, res) => {
  try {
    const zapAvailable = await pentestService.isZapAvailable()
    res.json({
      zapAvailable,
      targetUrl: process.env.PENTEST_TARGET_URL || 'http://localhost:8080',
      message: zapAvailable 
        ? 'OWASP ZAP is available for advanced scanning'
        : 'Basic security checks only (ZAP not configured)'
    })
  } catch (error) {
    res.status(500).json({ error: 'Failed to check pentest status' })
  }
})

/**
 * POST /api/pentest/scan
 * Run a penetration test scan (admin/developer only)
 */
router.post('/scan', requireRole('admin', 'developer'), async (req, res) => {
  try {
    const { targetUrl, quickScan = true, useZap = true } = req.body
    
    if (!targetUrl) {
      return res.status(400).json({ error: 'targetUrl is required' })
    }
    
    // Validate URL format
    try {
      new URL(targetUrl)
    } catch {
      return res.status(400).json({ error: 'Invalid URL format' })
    }
    
    // Check if in simulation mode
    const mode = process.env.PIPELINE_MODE || 'simulate'
    
    let result
    if (mode === 'simulate') {
      // Simulate delay
      await new Promise(resolve => setTimeout(resolve, 2000))
      result = pentestService.simulatePentest(targetUrl)
    } else {
      result = await pentestService.runFullPentest(targetUrl, { quickScan, useZap })
    }
    
    // Store result in database
    await pool.query(
      `INSERT INTO pentest_reports (target_url, result, created_by)
       VALUES ($1, $2, $3)`,
      [targetUrl, JSON.stringify(result), req.user.id]
    )
    
    res.json(result)
  } catch (error) {
    console.error('Pentest error:', error)
    res.status(500).json({ error: 'Penetration test failed' })
  }
})

/**
 * GET /api/pentest/basic/:targetUrl
 * Run basic security checks only
 */
router.get('/basic', async (req, res) => {
  try {
    const { url } = req.query
    
    if (!url) {
      return res.status(400).json({ error: 'url query parameter is required' })
    }
    
    const mode = process.env.PIPELINE_MODE || 'simulate'
    
    let result
    if (mode === 'simulate') {
      await new Promise(resolve => setTimeout(resolve, 1000))
      result = pentestService.simulatePentest(url).basicChecks
    } else {
      result = await pentestService.runBasicSecurityChecks(url)
    }
    
    res.json(result)
  } catch (error) {
    console.error('Basic security check error:', error)
    res.status(500).json({ error: 'Security check failed' })
  }
})

/**
 * GET /api/pentest/reports
 * Get recent pentest reports
 */
router.get('/reports', async (req, res) => {
  try {
    const result = await pool.query(
      `SELECT pr.*, u.username as created_by_name
       FROM pentest_reports pr
       LEFT JOIN users u ON pr.created_by = u.id
       ORDER BY pr.created_at DESC
       LIMIT 20`
    )
    
    res.json({ reports: result.rows })
  } catch (error) {
    console.error('Error fetching reports:', error)
    res.status(500).json({ error: 'Failed to fetch reports' })
  }
})

/**
 * GET /api/pentest/reports/:id
 * Get a specific pentest report
 */
router.get('/reports/:id', async (req, res) => {
  try {
    const { id } = req.params
    
    const result = await pool.query(
      `SELECT pr.*, u.username as created_by_name
       FROM pentest_reports pr
       LEFT JOIN users u ON pr.created_by = u.id
       WHERE pr.id = $1`,
      [id]
    )
    
    if (result.rows.length === 0) {
      return res.status(404).json({ error: 'Report not found' })
    }
    
    res.json(result.rows[0])
  } catch (error) {
    console.error('Error fetching report:', error)
    res.status(500).json({ error: 'Failed to fetch report' })
  }
})

/**
 * GET /api/pentest/pipeline/:pipelineId
 * Get pentest results for a specific pipeline
 */
router.get('/pipeline/:pipelineId', async (req, res) => {
  try {
    const { pipelineId } = req.params
    
    const result = await pool.query(
      `SELECT pentest_result FROM pipelines WHERE id = $1`,
      [pipelineId]
    )
    
    if (result.rows.length === 0) {
      return res.status(404).json({ error: 'Pipeline not found' })
    }
    
    const pentestResult = result.rows[0].pentest_result
    if (!pentestResult) {
      return res.json({ message: 'No pentest results for this pipeline' })
    }
    
    res.json(JSON.parse(pentestResult))
  } catch (error) {
    console.error('Error fetching pipeline pentest:', error)
    res.status(500).json({ error: 'Failed to fetch pentest results' })
  }
})

module.exports = router
