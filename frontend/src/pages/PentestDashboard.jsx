import { useState, useEffect } from 'react'
import { useAuth } from '../contexts/AuthContext'
import api from '../services/api'
import { Icons } from '../components/Icons'
import LoadingSpinner from '../components/LoadingSpinner'
import './PentestDashboard.css'

export default function PentestDashboard() {
  const { hasPermission } = useAuth()
  const [status, setStatus] = useState(null)
  const [loading, setLoading] = useState(true)
  const [targetUrl, setTargetUrl] = useState('http://localhost:8080')
  const [scanning, setScanning] = useState(false)
  const [report, setReport] = useState(null)
  const [reports, setReports] = useState([])

  const canRunScan = hasPermission('trigger')

  useEffect(() => {
    fetchData()
  }, [])

  const fetchData = async () => {
    try {
      const [statusRes, reportsRes] = await Promise.all([
        api.get('/pentest/status'),
        api.get('/pentest/reports')
      ])
      setStatus(statusRes.data)
      setReports(reportsRes.data.reports || [])
    } catch (err) {
      console.error('Error fetching pentest data:', err)
    } finally {
      setLoading(false)
    }
  }

  const runScan = async () => {
    if (!targetUrl.trim()) return
    
    setScanning(true)
    setReport(null)
    
    try {
      const response = await api.post('/pentest/scan', {
        targetUrl,
        quickScan: true,
        useZap: status?.zapAvailable
      })
      setReport(response.data)
      fetchData() // Refresh reports list
    } catch (err) {
      console.error('Scan error:', err)
      setReport({ error: 'Scan failed' })
    } finally {
      setScanning(false)
    }
  }

  const getSeverityClass = (severity) => {
    switch (severity?.toLowerCase()) {
      case 'high': return 'severity-high'
      case 'medium': return 'severity-medium'
      case 'low': return 'severity-low'
      default: return 'severity-info'
    }
  }

  const getStatusClass = (status) => {
    switch (status) {
      case 'passed': return 'check-passed'
      case 'warning': return 'check-warning'
      case 'failed': return 'check-failed'
      default: return ''
    }
  }

  if (loading) {
    return <LoadingSpinner message="Chargement..." />
  }

  return (
    <div className="pentest-dashboard">
      <div className="page-header">
        <div>
          <h1><span className="header-icon">{Icons.shield}</span> Tests de Sécurité</h1>
          <p className="subtitle">Analyse de vulnérabilités et tests d'intrusion</p>
        </div>
      </div>

      {/* Status Card */}
      <div className="status-card">
        <h3>Configuration</h3>
        <div className="status-grid">
          <div className="status-item">
            <span className="status-label">OWASP ZAP</span>
            <span className={`status-value ${status?.zapAvailable ? 'available' : 'unavailable'}`}>
              {status?.zapAvailable ? <><span className="status-icon">{Icons.success}</span> Disponible</> : <><span className="status-icon">{Icons.warning}</span> Non configuré</>}
            </span>
          </div>
          <div className="status-item">
            <span className="status-label">Mode</span>
            <span className="status-value">
              {status?.zapAvailable ? 'Scan avancé' : 'Vérifications de base'}
            </span>
          </div>
        </div>
      </div>

      {/* Scan Form */}
      {canRunScan && (
        <div className="scan-card">
          <h3><span className="scan-icon">{Icons.target}</span> Lancer un scan</h3>
          <div className="scan-form">
            <input
              type="url"
              placeholder="URL cible (ex: http://localhost:8080)"
              value={targetUrl}
              onChange={(e) => setTargetUrl(e.target.value)}
              disabled={scanning}
            />
            <button 
              onClick={runScan}
              disabled={scanning || !targetUrl.trim()}
              className="btn btn-primary"
            >
              {scanning ? (
                <>
                  <span className="spinner-small"></span>
                  Analyse en cours...
                </>
              ) : (
                <><span className="btn-icon">{Icons.search}</span> Analyser</>
              )}
            </button>
          </div>
          <p className="scan-hint">
            Le scan vérifie les en-têtes de sécurité, les chemins sensibles et les vulnérabilités courantes.
          </p>
        </div>
      )}

      {/* Scan Results */}
      {report && !report.error && (
        <div className="report-section">
          <h3><span className="report-icon">{Icons.chart}</span> Résultats du scan</h3>
          
          {/* Summary */}
          <div className="summary-card">
            <div className="summary-header">
              <span className="summary-title">Résumé</span>
              <span className={`summary-status ${
                report.vulnerabilities?.high > 0 ? 'critical' :
                report.vulnerabilities?.medium > 0 ? 'warning' : 'passed'
              }`}>
                {report.summary}
              </span>
            </div>
          </div>

          {/* Vulnerability Counts */}
          <div className="vuln-grid">
            <div className="vuln-card vuln-high">
              <span className="vuln-count">{report.vulnerabilities?.high || 0}</span>
              <span className="vuln-label"><span className="vuln-dot">{Icons.dotRed}</span> Élevées</span>
            </div>
            <div className="vuln-card vuln-medium">
              <span className="vuln-count">{report.vulnerabilities?.medium || 0}</span>
              <span className="vuln-label"><span className="vuln-dot">{Icons.dotOrange}</span> Moyennes</span>
            </div>
            <div className="vuln-card vuln-low">
              <span className="vuln-count">{report.vulnerabilities?.low || 0}</span>
              <span className="vuln-label"><span className="vuln-dot">{Icons.dotYellow}</span> Faibles</span>
            </div>
            <div className="vuln-card vuln-info">
              <span className="vuln-count">{report.vulnerabilities?.informational || 0}</span>
              <span className="vuln-label"><span className="vuln-dot">{Icons.dotBlue}</span> Info</span>
            </div>
          </div>

          {/* Basic Checks */}
          {report.basicChecks && (
            <div className="checks-section">
              <h4><span className="checks-icon">{Icons.shieldCheck}</span> Vérifications de sécurité</h4>
              <div className="checks-summary">
                <span className="check-stat passed"><span className="stat-icon">{Icons.success}</span> {report.basicChecks.passed} réussis</span>
                <span className="check-stat warnings"><span className="stat-icon">{Icons.warning}</span> {report.basicChecks.warnings} avertissements</span>
                <span className="check-stat failed"><span className="stat-icon">{Icons.error}</span> {report.basicChecks.failed} échoués</span>
              </div>
              <div className="checks-list">
                {report.basicChecks.checks?.map((check, i) => (
                  <div key={i} className={`check-item ${getStatusClass(check.status)}`}>
                    <span className="check-icon">
                      {check.status === 'passed' ? Icons.success : check.status === 'warning' ? Icons.warning : Icons.error}
                    </span>
                    <div className="check-info">
                      <span className="check-name">{check.name}</span>
                      <span className="check-desc">{check.description}</span>
                    </div>
                    <span className={`check-severity ${getSeverityClass(check.severity)}`}>
                      {check.severity}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Alerts */}
          {report.alerts && report.alerts.length > 0 && (
            <div className="alerts-section">
              <h4><span className="alerts-icon">{Icons.shieldAlert}</span> Alertes détectées</h4>
              <div className="alerts-list">
                {report.alerts.map((alert, i) => (
                  <div key={i} className={`alert-item ${getSeverityClass(alert.risk)}`}>
                    <div className="alert-header">
                      <span className="alert-risk">{alert.risk}</span>
                      <span className="alert-name">{alert.name}</span>
                    </div>
                    <p className="alert-desc">{alert.description}</p>
                    {alert.solution && (
                      <p className="alert-solution">
                        <strong>Solution:</strong> {alert.solution}
                      </p>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      {report?.error && (
        <div className="error-card">
          <h3><span className="error-icon">{Icons.error}</span> Erreur</h3>
          <p>{report.error}</p>
        </div>
      )}

      {/* Recent Reports */}
      {reports.length > 0 && (
        <div className="reports-section">
          <h3><span className="reports-icon">{Icons.scroll}</span> Rapports récents</h3>
          <div className="reports-list">
            {reports.map((r) => {
              const result = JSON.parse(r.result || '{}')
              return (
                <div key={r.id} className="report-item">
                  <div className="report-target">{r.target_url}</div>
                  <div className="report-meta">
                    <span>Par {r.created_by_name || 'Inconnu'}</span>
                    <span>{new Date(r.created_at).toLocaleString('fr-FR')}</span>
                  </div>
                  <div className="report-vulns">
                    <span className="vuln-badge high">{result.vulnerabilities?.high || 0} H</span>
                    <span className="vuln-badge medium">{result.vulnerabilities?.medium || 0} M</span>
                    <span className="vuln-badge low">{result.vulnerabilities?.low || 0} L</span>
                  </div>
                </div>
              )
            })}
          </div>
        </div>
      )}

      {/* Help */}
      <div className="help-section">
        <h3><span className="help-icon">{Icons.lightbulb}</span> À propos des tests de sécurité</h3>
        <div className="help-content">
          <p>
            Les tests de sécurité sont exécutés automatiquement à la fin de chaque pipeline 
            après le déploiement réussi de l'application.
          </p>
          <h4>Types de vérifications :</h4>
          <ul>
            <li><strong>En-têtes de sécurité</strong> : X-Frame-Options, CSP, HSTS, etc.</li>
            <li><strong>Chemins sensibles</strong> : .env, .git, fichiers de sauvegarde</li>
            <li><strong>Divulgation d'informations</strong> : Versions de serveur, stack technologique</li>
            <li><strong>Scan OWASP ZAP</strong> : Injection SQL, XSS, CSRF (si configuré)</li>
          </ul>
        </div>
      </div>
    </div>
  )
}
